======================================================
				shellè„šæœ¬ç»¼åˆæ¡ˆä¾‹
======================================================

		
		
ä¸€ã€ç¼–å†™æºç å®‰è£…ç³»ç»ŸæœåŠ¡å¯åŠ¨è„šæœ¬
	
	RHEL6ï¼š
	
#!/bin/sh
#
# nginx - this script starts and stops the nginx daemin
#
# chkconfig:   - 85 15 
# description:  Nginx is an HTTP(S) server, HTTP(S) reverse \
#               proxy and IMAP/POP3 proxy server


	æœåŠ¡è„šæœ¬æ”¾ç½®è·¯å¾„ï¼š/etc/init.d
	è„šæœ¬å¢åŠ æ‰§è¡Œæƒé™ï¼šchmod +x /etc/init.d/nginx
	æ·»åŠ æˆç³»ç»ŸæœåŠ¡è„šæœ¬ï¼šchkconfig --add nginx
	è®¾ç½®å¼€æœºè‡ªå¯åŠ¨ï¼šchkconfig --level 35 nginx on
	
	
	RHEL7:
	Centos ç³»ç»ŸæœåŠ¡è„šæœ¬ç›®å½•ï¼š 

	1. /usr/lib/systemd/  
	æœ‰ç³»ç»Ÿï¼ˆsystemï¼‰å’Œç”¨æˆ·ï¼ˆuserï¼‰ä¹‹åˆ†ï¼Œ 
	å¦‚éœ€è¦å¼€æœºæ²¡æœ‰ç™»é™†æƒ…å†µä¸‹å°±èƒ½è¿è¡Œçš„ç¨‹åºï¼Œå­˜åœ¨ç³»ç»ŸæœåŠ¡ï¼ˆsystemï¼‰é‡Œï¼Œå³ï¼š
 
	2. /lib/systemd/system/  
	åä¹‹ï¼Œç”¨æˆ·ç™»å½•åæ‰èƒ½è¿è¡Œçš„ç¨‹åºï¼Œå­˜åœ¨ç”¨æˆ·ï¼ˆuserï¼‰é‡Œ 
	æœåŠ¡ä»¥.serviceç»“å°¾ã€‚
	è¿™è¾¹ä»¥nginxå¼€æœºè¿è¡Œä¸ºä¾‹
	
	#vim /usr/lib/systemd/system/nginx.service
	[Unit]
	Description=nginx - high performance web server 
	Documentation=http://nginx.org/en/docs/
	After=network.target remote-fs.target nss-lookup.target
	
	
	[Service]
	Type=forking
	PIDFile=/var/run/nginx.pid
	ExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf
	ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf
	ExecReload=/bin/kill -s HUP $MAINPID
	ExecStop=/bin/kill -s QUIT $MAINPID
	PrivateTmp=true
	
	[Install]
	WantedBy=multi-user.target
	
	
	
	[Unit]:æœåŠ¡çš„è¯´æ˜
	Description:æè¿°æœåŠ¡
	After:æè¿°æœåŠ¡ç±»åˆ«
	
	[Service]æœåŠ¡è¿è¡Œå‚æ•°çš„è®¾ç½®
	Type=forkingæ˜¯åå°è¿è¡Œçš„å½¢å¼
	ExecStartä¸ºæœåŠ¡çš„å…·ä½“è¿è¡Œå‘½ä»¤
	ExecReloadä¸ºé‡å¯å‘½ä»¤
	ExecStopä¸ºåœæ­¢å‘½ä»¤
	PrivateTmp=Trueè¡¨ç¤ºç»™æœåŠ¡åˆ†é…ç‹¬ç«‹çš„ä¸´æ—¶ç©ºé—´
	
	æ³¨æ„ï¼š[Service]çš„å¯åŠ¨ã€é‡å¯ã€åœæ­¢å‘½ä»¤å…¨éƒ¨è¦æ±‚ä½¿ç”¨ç»å¯¹è·¯å¾„
	
	[Install]è¿è¡Œçº§åˆ«ä¸‹æœåŠ¡å®‰è£…çš„ç›¸å…³è®¾ç½®ï¼Œå¯è®¾ç½®ä¸ºå¤šç”¨æˆ·ï¼Œå³ç³»ç»Ÿè¿è¡Œçº§åˆ«ä¸º3
	

äºŒã€æ•°æ®åº“å¤‡ä»½
	1ã€ä½¿ç”¨mysqldumpå®ç°åˆ†åº“åˆ†è¡¨å¤‡ä»½
	
	yum install mariadb mariadb-server -y
	
	mysqldump -uuser -ppasswd -B db1 > /server/dbbak/db1.sql
	
	åˆ†åº“ï¼š
	db1  db2 
	å¤‡ä»½ï¼š
	for db in db1 db2
	do
	    mysqldump -uuser -ppasswd -B $db > /server/dbbak/$db.sql
	
	done
	
	
åˆ†åº“å¤‡ä»½ï¼š	
#!/bin/bash
# Date: 		2016-12-28
# Author:		kongd
# E-Mail:   	abc@sohu.com
# Description:	Use mysqldump backup MySQL
# ver:			v0.1

# define var
bak_user=root
bak_passwd=123456
bak_path=/server/dbbak
bak_cmd="-u$bak_user -p$bak_passwd"
exclude_db="Database|information_schema|mysql|performance_schema|test"
db_name=`mysql $bak_cmd -e "show databases;" | egrep -v $exclude_db`


# main program
for db in `echo $db_name`
do
	[ -d $bak_path ] || mkdir -p $bak_path
	mysqldump $bak_cmd -B $db |gzip> $bak_path/${db}_`date +%Y%m%d`.sql.gz
done

åˆ†è¡¨å¤‡ä»½ï¼š

#!/bin/bash
# Date: 		2016-12-28
# Author:		kongd
# E-Mail:   	abc@sohu.com
# Description:	Use mysqldump backup MySQL tables
# ver:			v0.1

# define var
bak_user=root
bak_passwd=123456
bak_path=/server/dbbak
bak_cmd="-u$bak_user -p$bak_passwd"
exclude_db="Database|information_schema|mysql|performance_schema|test"
db_name=`mysql $bak_cmd -e "show databases;" | egrep -v $exclude_db`



# main program
for db in `echo $db_name`
do
	[ -d ${bak_path}/$db ] || mkdir -p ${bak_path}/$db
	table_name=`mysql $bak_cmd -e "use $db;show tables;" | grep -v "Tables_in"`
	for table in `echo ${table_name}`
	do
	    mysqldump $bak_cmd $db $table |gzip > $bak_path/${db}/${db}_${table}.`date +%Y%m%d`.sql.gz
	done
done

2ã€å…¨ç½‘å¤‡ä»½
	åº”ç”¨åœºæ™¯ï¼šå¤‡ä»½å…¬å¸webæœåŠ¡å™¨æ•°æ®ï¼Œæ—¥å¿—ä»¥åŠç³»ç»Ÿé…ç½®ä¿¡æ¯ã€‚
	è„šæœ¬è¯´æ˜ï¼šæœ¬åœ°ä½¿ç”¨tarå¤‡ä»½ï¼Œå¤‡ä»½å®Œæˆæ—¶ä½¿ç”¨md5sum ç”Ÿæˆæ ‡å¿—ä»¥ä¾¿å¤‡ä»½æœåŠ¡å™¨ä¸Šæ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸï¼Œå¤‡ä»½ç»“æœç”¨rsyncæ¨é€åˆ°å¤‡ä»½æœåŠ¡å™¨ï¼ˆä¹Ÿå¯ä½¿ç”¨ftpæ–¹å¼ä¸Šä¼ è‡³ftpæœåŠ¡å™¨ï¼‰ï¼Œå¤‡ä»½æœåŠ¡å™¨æ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸå¹¶å‘é€é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜ã€‚
	å¤‡ä»½æœ¬åœ°ä¿ç•™ä¸€å‘¨ï¼ŒæœåŠ¡å™¨ä¿ç•™ä¸€æœˆæ•°æ®ã€‚
{
	åˆ†æï¼šéœ€è¦å¤‡ä»½å†…å®¹ï¼ˆ1-4ä¸ºé…ç½®æ–‡ä»¶ï¼Œ5-6ä¸ºwebæœåŠ¡å™¨æ•°æ®åŠæ—¥å¿—ï¼‰
			1ã€å®šæ—¶ä»»åŠ¡æœåŠ¡çš„é…ç½®æ–‡ä»¶/var/spool/cron/root
			2ã€å¼€æœºè‡ªå¯åŠ¨é…ç½®æ–‡ä»¶/etc/rc.local
			3ã€æ—¥å¸¸è„šæœ¬çš„ç›®å½•
			4ã€é˜²ç«å¢™iptablesçš„é…ç½®æ–‡ä»¶/etc/sysconfig/iptables
			5ã€webæœåŠ¡å™¨æ•°æ®ï¼Œå‡å®šä¸º/var/www/html
			6ã€æ—¥å¿—ï¼Œå‡å®šä¸º/var/log/httpd
		é¦–å…ˆï¼Œé…ç½®å¥½rsyncæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼Œå¹¶æµ‹è¯•å¯ä»¥ä½¿ç”¨ï¼›
		å…¶æ¬¡ï¼Œæœ¬åœ°taræ‰“åŒ…å¤‡ä»½ï¼›
		å†æ¬¡ï¼Œä½¿ç”¨rsyncæ¨é€åˆ°æœåŠ¡å™¨ï¼›
		æœ€åï¼ŒæœåŠ¡å™¨ç«¯æ£€æŸ¥å¹¶é‚®ä»¶å‘Šè­¦ï¼›
	    æµ‹è¯•å„ä¸ªé˜¶æ®µéƒ½æ²¡é—®é¢˜ï¼Œè®¾ç½®å®šæ—¶ä»»åŠ¡ã€‚

ä»£ç ï¼š{ä»£ç å¼€å§‹
#!/bin/bash

#define var
IP=`ifconfig eth0 | awk -F '[ :]+' 'NR==2 {print $4}'`
Today=$(date +%F)
Path=/backup/$IP
COFING_data="var/spool/cron/root etc/rc.local etc/sysconfig/iptables Server/Scripts/"
WEB_data=var/www/html
WEB_log=var/log/httpd
BAK_CONFIG_NAME=config.$Today.tar.gz
BAK_WEB_DATA_NAME=web_data.$Today.tar.gz
BAK_WEB_LOG_NAME=web_log.$Today.tar.gz
BAK_Server=192.168.147.200
Flag_file=flag.$Today.txt

#backup
[ -d $Path ] || mkdir -p $Path
cd / && \
tar czf $Path/${BAK_CONFIG_NAME} ${COFING_data} && \
tar czf $Path/${BAK_WEB_DATA_NAME} ${WEB_data} && \
tar czf /$Path/${BAK_WEB_LOG_NAME} ${WEB_log}

#check backup && make Flag_file
if [ $? == 0 ]
then
        find $Path -type f -name "*$Today.tar.gz" | xargs md5sum >> $Path/${Flag_file}
else
        echo "backup Failure" >> $Path/${Flag_file}
        exit 1
fi

#to backup server
rsync -az /backup/ rsync_backup@${BAK_Server}::backup --password-file=/etc/rsyncd.passwd

#del local backup file,Keep a week data 
find $Path -type f -name "*.tar.gz" -mtime +7 | xargs rm -f	
	
	ä»£ç ç»“æŸ}	
	
	æœåŠ¡å™¨ç«¯æ£€æŸ¥é‚®ä»¶å‘Šè­¦è„šæœ¬åœ¨æœåŠ¡ç«¯å®Œæˆï¼š
	{ä»£ç å¼€å§‹
#!/bin/bash

#define var
Today=$(date +%F)
Flag_file=/backup/192.168.147.128/flag.$Today.txt
Mail_file=/opt/mail_bak_${Today}.txt

#check flag
if [ ! -f ${Flag_file} ]
then
        echo "backup is error,pls view back server" > ${Mail_file}
else
        find  /backup -type f -name "flag.$(date +%F)*" | xargs md5sum -c | grep FAILED > ${Mail_file}
fi

#check Mail_file
if [ -s ${Mail_file} ]
then
        mail -s "$(date +%F-%T) back" esen_monitor@163.com <${Mail_file}
else
        echo "backup is success!"
fi

#del remote bak file,30 days keep data 
find /backup -type f -name "*.tar.gz" -mtime +30 | xargs rm -f

	
	ä»£ç ç»“æŸ}
	
	
}

	3ã€åŸºäºInnobackupexçš„MySQLå¤‡ä»½è„šæœ¬
	å…·ä½“è¦æ±‚ï¼š
    	1ã€å‘¨æ—¥å…¨å¤‡
    	2ã€å‘¨ä¸€è‡³å‘¨å…­å¢é‡å¤‡ä»½
    	3ã€å¤‡ä»½ä½¿ç”¨backupç”¨æˆ·
    	grant SELECT,RELOAD,SHOW DATABASES,LOCK TABLES,SUPER,REPLICATION CLIENT on *.* to backup@'localhost' identified by '123456';
    	4ã€å¤‡ä»½åè¿›è¡Œå‹ç¼©å¹¶å°†å¤‡ä»½ä¸Šä¼ è‡³ftpæœåŠ¡å™¨
    	5ã€å¤‡ä»½åœ¨æœ¬æœºä¿å­˜ä¸€å‘¨æ•°æ®ï¼ŒftpæœåŠ¡å™¨ç«¯ä¿ç•™åŠæœˆ
    	6ã€ç»“åˆè®¡åˆ’ä»»åŠ¡ï¼Œå¤‡ä»½æ—¶é—´ä¸ºæ¯å¤©02:00:00
#!/bin/bash

##########################################################################  
# File     : innobk.sh                                                   #   
# Author   : kongdan                                                     #
# E-Mail   : kongdan@hzitedu.com                                         #
# Date     : 20161224                                                    #  
# Description :                                                          #  
#    The script will call innobackupex to                                #  
#    take a full or increment backup for mysql db.                       #  
#    Currently it will take follow principal to backup:                  #  
#       Sun take full backup.                                            #    
#       Mon,Tue,Wend,Thur,Fri,Sat take incremental backup.               #  
#                                                                        #  
# Usage Example:                                                         #  
#     innobk.sh                                                          #
##########################################################################  

  
# Check to use root users to run scripts
if [ "`whoami`" != "root" ]
then
    echo "please Run script using root user!"
    exit 1    
fi

# Defined variables

bak_dir=/server/backup/dbback
log_dir=${bak_dir}/log  
cmdInno=/usr/bin/innobackupex  
sock=/var/lib/mysql/mysql.sock
config_file=/etc/my.cnf
bak_user=backup
bak_passwd=123456
bak_cmd="$cmdInno --user=${bak_user} --password=${bak_passwd} --defaults-file=${config_file} --socket=${sock} --no-timestamp"

day=`date +%u`  
lastday=`date -d '-1 day' +%Y%m%d`
dt=`date +%Y%m%d`
ts=`date +%Y%m%d%H%M%S`
log_file=${log_dir}/innobak_${ts}.log

# Defined bak check variables
check_flag="completed OK"
mail_user="root@locallhost"

# Defined FTP server variables
ftp_host=192.168.95.100
ftp_user=backup
ftp_passwd=backup
deldate=`date -d '-7 day' +%Y%m%d`
ftp_log_file=${log_dir}/ftp_${ts}.log


# Check backup directory  

[ ! -d "${bak_dir}" ] && mkdir -p ${bak_dir}
[ ! -d "${log_dir}" ] && mkdir -p ${log_dir}

# backup log 
echo "Start innobackup at `date`."               >>${log_file} 
echo "Current defaults file is : ${config_file}" >>${log_file}
echo "Current host is : `hostname -s`"           >>${log_file} 
echo "Current mysql user is : ${bak_user}"       >>${log_file}
echo "Current password is : ${bak_passwd}"       >>${log_file}
echo "Current log directory is : ${log_dir}"     >>${log_file}  
echo "Current log file is : ${log_file}"         >>${log_file}
  
# Define backup function for full and incremental backup type.  
bak_full()
{  
    [ ! -d "${bak_dir}/full_${dt}" ] && ( 
        echo "$bak_cmd ${bak_dir}/full_${dt}  2> ${log_dir}/bak_$ts.log" >>${log_file}
        $bak_cmd ${bak_dir}/full_${dt}  2> ${log_dir}/bak_$ts.log
    )
}
  
bak_inc()  
{  
    [ ! -d "${bak_dir}/inc_${dt}" ] && (
        echo "$bak_cmd --incremental ${bak_dir}/inc_$dt --incremental-basedir=$basedir 2>${log_dir}/bak_${ts}.log" >>${log_file}
        $bak_cmd --incremental ${bak_dir}/inc_$dt --incremental-basedir=$basedir  2>${log_dir}/bak_${ts}.log
    )
}


bak_check()
{
	tail -1 ${log_dir}/bak_${dt}*.log | grep "$check_flag" &> /dev/null 
	[ $? -ne 0 ] &&  echo "`date +"%F %T"`: Backup MySQL Failue" | mail -s "Backup MySQL Failue" ${mail_user}
}

echo "Start put to FTP server at `date`."              >>${ftp_log_file}
echo "Current host is : `hostname -s`"                 >>${ftp_log_file}
echo "Upload FTP server address : ${ftp_host}"         >>${ftp_log_file}
echo "Upload FTP server backup user : ${ftp_user}"     >>${ftp_log_file}
echo "Upload FTP server backup passwd : ${ftp_passwd}" >>${ftp_log_file}
echo "Put to FTP server log directory is : ${log_dir}" >>${ftp_log_file}

put_ftp()
{
    cd ${bak_dir} 
    [ -f ${bak_name}.tar.gz ] || {
        tar czf ${bak_name}.tar.gz ${bak_name}
        lftp -u ${ftp_user},${ftp_passwd} ftp://${ftp_host} <<EOF
mkdir ${dt}
cd ${dt}
mput ${bak_name}.tar.gz
cd ..
rm -rf $deldate
close
bye
EOF
        echo "Upload backup to FTP server end at `date`."      >>${ftp_log_file}
    }
}


# Main program
if [ $day -eq 7 ]
then
	bak_full
        bak_check
	bak_name=full_$dt
	put_ftp
elif [ $day -eq 1 ]
then
	basedir=${bak_dir}/full_$lastday
	bak_inc
	bak_check
	bak_name=inc_$dt
	put_ftp	
else
	basedir=${bak_dir}/inc_$lastday
	bak_inc
	bak_check
	bak_name=inc_$dt
	put_ftp	
fi


# Check backup log ,remove history logfile and bacupset.
find ${bak_dir} -type f -mtime +6 -exec rm {} \;
find ${log_dir} -type f -mtime +6 -exec rm {} \;


ä¸‰ã€ç›‘æ§è„šæœ¬
WebæœåŠ¡å™¨ç›‘æ§
	åº”ç”¨åœºæ™¯ï¼šç›‘æ§webæœåŠ¡å™¨çŠ¶æ€ï¼Œå¼‚å¸¸æ—¶é‚®ä»¶æŠ¥è­¦ã€‚
	è„šæœ¬è¯´æ˜ï¼šé€šè¿‡wgetï¼ˆä¹Ÿå¯ä»¥ç”¨curlï¼‰ç›‘æ§æœåŠ¡å™¨çŠ¶æ€ï¼Œå¦‚æœä¸èƒ½æ­£å¸¸è®¿é—®ï¼Œpingæ£€æµ‹ç½‘ç»œï¼Œç½‘ç»œæ­£å¸¸é€šçŸ¥ç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡ï¼Œpingä¸é€šé‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜ã€‚
	æœåŠ¡å™¨åˆ—è¡¨ä½¿ç”¨æ•°ç»„ï¼ŒæœåŠ¡å™¨çŠ¶æ€å‡½æ•°ä½¿ç”¨è¿”å›å€¼åˆ¤æ–­æœåŠ¡å™¨æ˜¯å¦å¼‚å¸¸ã€‚
{
	
	ä»£ç ï¼š{ä»£ç å¼€å§‹
#!/bin/bash

#define var
RETVAL=0
FAILCOUNT=0
MAIL_USER="esen_monitor@163.com"

RED='\033[31m'
GREEN='\033[32m'
BLUE='\033[34m'
CLOSE='\033[0m'

#define server list
SERVER_ALL_LIST=(
172.21.200.16:80
172.21.200.200:80
172.21.200.15:9080
)

SERVER_ALL_LEN=${#SERVER_ALL_LIST[*]}

#web detection function
LOG_FILE="/tmp/web_check.log"

function GetUrlStatus() {
	for ((j=1;j<=3;j++))
	do
		wget -T 10 --tries=1 --spider http://${1} > /dev/null 2>&1
		if [ $? -ne 0 ] 
		then 
			let FAILCOUNT+=1
		else
			FAILCOUNT=0
			break
		fi
	done

	[ $FAILCOUNT -gt 1 ] && RETVAL=1 || RETVAL=0
	return $RETVAL
}

function Send_Mail() {
	NowTime=$(date +"%Y-%m-%d %H:%M:%S")
	SC="http://${1} service is error,${NowTime}."
	mail -s "$SC" $MAIL_USER < ${LOG_FILE}
}

#service check
i=0
while [ $i -lt ${SERVER_ALL_LEN} ]
do
	SERVER_IP=$(echo ${SERVER_ALL_LIST[$i]} | awk -F: '{print $1}')
	SERVER_PORT=$(echo ${SERVER_ALL_LIST[$i]} | awk -F: '{print $2}')
	echo -n -e  "${BLUE} check ${SERVER_ALL_LIST[$i]}: ${CLOSE}" |tee ${LOG_FILE}
	if GetUrlStatus ${SERVER_ALL_LIST[$i]} 
	then
		echo -e "${GREEN} Server is working properly! ${CLOSE}" 
		elif ping -c 1 $SERVER_IP > /dev/null 2>&1
		then
			echo -e "${RED} ping ok,pls check service! ${CLOSE}" |tee -a ${LOG_FILE}
			Send_Mail ${SERVER_ALL_LIST[$i]}
	else
		echo -e "${RED} ping failure,pls Contact your administrator! ${CLOSE}" |tee -a ${LOG_FILE}
		Send_Mail ${SERVER_ALL_LIST[$i]}
	fi

	let i++
done
#Delete temporary files
rm -f ${LOG_FILE}

	
	ä»£ç ç»“æŸ}
	
è„šæœ¬æ‰§è¡ŒåŠæµ‹è¯•:{
[root@localhost Scripts]# sh check_url.sh 
 check 172.21.200.16:80:  ping failure,pls Contact your administrator! 
 check 172.21.200.200:80:  ping ok,pls check service! 
 check 172.21.200.15:9080:  Server is working properly! 
 é‚®ä»¶æŠ¥è­¦ï¼šï¼ˆé‚®ä»¶ä¸­é¢œè‰²æ— æ³•æ˜¾ç¤ºï¼‰
 [34m check 172.21.200.16:80: [0m[31m ping failure,pls Contact your administrator! [0m
}
å…¶ä»–æ£€æµ‹æ–¹æ³•ï¼š
	ä½¿ç”¨curlæ£€æµ‹ï¼š
	function GetUrlStatus() {
	for ((j=1;j<=3;j++))
	do
		SERVER_STATUS_CODE=$(curl -o /dev/null -s -m 10 --connect-timeout 10 -w %{http_code} "http://${1}")
		if [ ${SERVER_STATUS_CODE} -ne 200 ] 
		then 
			let FAILCOUNT+=1
		else
			FAILCOUNT=0
			break
		fi
	done

	[ $FAILCOUNT -gt 1 ] && RETVAL=1 || RETVAL=0
    return $RETVAL
		
	ä½¿ç”¨nmapæ¢æµ‹ç«¯å£æ˜¯å¦openåˆ¤æ–­æœåŠ¡æ˜¯å¦å¼‚å¸¸ï¼š
	function GetUrlStatus() {
	for ((j=1;j<=3;j++))
	do
		SERVER_PORT_STATUS=$(nmap -P0 -p${SERVER_PORT} -sS -vv ${SERVER_IP} | grep ${SERVER_PORT} | tail -1 | awk '{print $2}')
		if [ "${SERVER_PORT_STATUS}" != "open" ] 
		then 
			let FAILCOUNT+=1
		else
			FAILCOUNT=0
			break
		fi
	done
	
	[ $FAILCOUNT -gt 1 ] && RETVAL=1 || RETVAL=0
    return $RETVAL
}
}	

å››ã€å®‰å…¨è„šæœ¬
	
4ã€è‡ªåŠ¨åŒ–ç¦æ­¢æ¶æ„IPè®¿é—®
	åº”ç”¨åœºæ™¯ï¼šé˜²æ­¢æ¶æ„IPå°è¯•sshç™»å½•ã€‚
	è„šæœ¬è¯´æ˜ï¼šå°†å¯†ç è¾“å…¥é”™è¯¯è¶…è¿‡4æ¬¡çš„IPåœ°å€é€šè¿‡iptablesé˜²ç«å¢™é˜»æ­¢è®¿é—®ã€‚
	
	åˆ†æï¼š
		1ï¼‰é¦–å…ˆï¼Œéœ€è¦çŸ¥é“sshè¿œç¨‹è®¿é—®è®°å½•åœ¨å“ªä¸ªæ–‡ä»¶ä¸­/var/log/secure
		2ï¼‰å…¶æ¬¡ï¼Œæ¨¡æ‹Ÿè¿œç¨‹è®¿é—®è¾“é”™å¯†ç ï¼ŒæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
		Dec 26 11:34:53 agent1 sshd[3060]: Failed password for root from 192.168.211.1 port 2075 ssh2
		3ï¼‰å†æ¬¡ï¼Œé€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°å…³é”®ä¿¡æ¯â€œFailed passwordâ€è¡¨ç¤ºå¯†ç é”™è¯¯
		   æœ‰å¯èƒ½æ˜¯æ‰‹è¯¯è¾“é”™ï¼Œæ‰€ä»¥å°±éœ€è¦è®¾å®šå‡ æ¬¡é”™è¯¯ä¸ºæ¶æ„è¯•æ¢å¯†ç ï¼Œå»ºè®®è®¾ç½®ä¸º4
		   å¦ä¸€ä¸ªå…³é”®ä¿¡æ¯æ˜¯éœ€è¦å°†å¯†ç é”™è¯¯çš„IPåœ°å€æå–å‡ºæ¥
		   å¯¹æå–å‡ºæ¥çš„IPåœ°å€è¿›è¡Œç»Ÿè®¡æ¬¡æ•°
		4ï¼‰æœ€åï¼Œéœ€è¦æ˜ç¡®æ€ä¹ˆåœ¨è„šæœ¬ä¸­é€šè¿‡iptablesç­–ç•¥è®¾ç½®é˜»æ­¢æ¶æ„IPè®¿é—®
			ç­–ç•¥æ·»åŠ åˆ°å“ªé‡Œåˆé€‚
			é˜²ç«å¢™é…ç½®æ–‡ä»¶ç­‰

#!/bin/bash
#Name: auto_deny_ip.sh
#Description: Prohibit malicious IP attack access
#Author: kongd
#Mail: author@qq.com
#Version: 0.0.1
#Date: 2015-08-22 01:51:42
#Usage: auto_deny_ip.sh

#define var
SEC_FILE=/var/log/secure
IPTABLES_CONF=/etc/sysconfig/iptables

IP_ADDR=`tail -1000 ${SEC_FILE} | grep "Failed password" | egrep -o "([0-9]{1,3}\.){3}[0-9]{1,3}" | sort -nr| uniq -c | awk '$1>4 {print $2}'`
# IP_ADDR=`tail -1000 ${SEC_FILE} | awk '/Failed password/ {print $((NF-3))}'| sort -nr | uniq -c | awk '$1>4 {print $1}'`

for i in `echo ${IP_ADDR}`
do
	grep $i ${IPTABLES_CONF}
	if [ $? -ne 0 ]
	then
		sed -i "/lo/a -A INPUT -s $i -p tcp -m state --state NEW -m tcp --dport 22 -j DROP" ${IPTABLES_CONF}
	else
		echo "This is $i is esist in iptables,please exit..."
	fi
done

/etc/init.d/iptables restart			
# ä»¥ä¸Šè„šæœ¬æœ‰bugï¼Œå¦‚æœipåœ¨é˜²ç«å¢™ä¸­å¯èƒ½å¯¼è‡´æ— æ³•æ·»åŠ ï¼Œæ¯”å¦‚ä¸€ä¸ªipè®¾ç½®äº†å…è®¸è®¿é—®80ç«¯å£ï¼Œé‚£ä¹ˆæ­¤è„šæœ¬è¿è¡Œåæ— æ³•å®ç°é˜»æ­¢æ­¤IP sshè¿æ¥æœåŠ¡å™¨


===================ä¸‹é¢ä»£ç ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶è§£å†³ä»¥ä¸Šbug========================
# cat denyIP.sh 
#!/bin/bash

# å®šä¹‰å˜é‡
logFile=/var/log/secure #æ—¥å¿—æ–‡ä»¶

IP=`awk '/Failed password/ {++IP[$(NF-3)]}  END {for (v in IP) {if (IP[v] >=4) {print v}}}' ${logFile}` #ssh å¯†ç é”™è¯¯çš„IP
CTL="INPUT -p tcp -m tcp --dport 22 -s"


for v in $IP
do

	iptables -L -n | tr -s " " | awk -F"[ :]" '/^DROP/ && $NF==22 {print $4}' > ipTempList #å°†å·²ç»æ·»åŠ sshæ‹’ç»IPè®°å½•åˆ°ä¸´æ—¶æ–‡ä»¶
	
	if ! grep "$v" ipTempList &>/dev/null
	then
		iptables -I ${CTL} ${v} -j DROP
	fi

done


service iptables save
rm -f ipTempList #åˆ é™¤ä¸´æ—¶æ–‡ä»¶

====================ä¸‹é¢ä½¿ç”¨ä¸´æ—¶å˜é‡==============================
# cat denyIP.sh 
#!/bin/bash

# å®šä¹‰å˜é‡
logFile=/var/log/secure #æ—¥å¿—æ–‡ä»¶

IP=`awk '/Failed password/ {++IP[$(NF-3)]}  END {for (v in IP) {if (IP[v] >=4) {print v}}}' ${logFile}` #ssh å¯†ç é”™è¯¯çš„IP
CTL="INPUT -p tcp -m tcp --dport 22 -s"


for v in $IP
do

	ipList=`iptables -L -n | tr -s " " | awk -F"[ :]" '/^DROP/ && $NF==22 {print $4}'`  #å°†å·²ç»æ·»åŠ sshæ‹’ç»IPè®°å½•åˆ°ä¸´æ—¶å˜é‡
	
	if !  echo ${ipList} |grep "$v" &>/dev/null
	then
		iptables -I ${CTL} ${v} -j DROP
	fi

done


service iptables save
unset ipList #åˆ é™¤ä¸´æ—¶å˜é‡



=====================ä¸‹é¢ä»£ç ä½¿ç”¨ä¸´æ—¶æ•°ç»„============================

# cat denyIP.sh 
#!/bin/bash

# å®šä¹‰å˜é‡
logFile=/var/log/secure #æ—¥å¿—æ–‡ä»¶

IP=`awk '/Failed password/ {++IP[$(NF-3)]}  END {for (v in IP) {if (IP[v] >=4) {print v}}}' ${logFile}` #ssh å¯†ç é”™è¯¯çš„IP
CTL="INPUT -p tcp -m tcp --dport 22 -s"


for v in $IP
do

	ipList=(`iptables -L -n | tr -s " " | awk -F"[ :]" '/^DROP/ && $NF==22 {print $4}'`)  #å°†å·²ç»æ·»åŠ sshæ‹’ç»IPè®°å½•åˆ°ä¸´æ—¶æ•°ç»„
	
	if !  echo ${ipList[*]} |grep "$v" &>/dev/null
	then
		iptables -I ${CTL} ${v} -j DROP
	fi

done


service iptables save
unset ipList #åˆ é™¤ä¸´æ—¶å˜é‡
